services:
  agentk-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: agentk-mcp-server
    ports:
      - "3333:3333"
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - FASTMCP_HOST=${FASTMCP_HOST:-0.0.0.0}
      - FASTMCP_PORT=${FASTMCP_PORT:-3333}
      - KUBECONFIG=/app/config
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - /home/ftt_grupotcc2026_1/AgentK-MCP/kubeconfig:/app/config:ro
    networks:
      - agentk-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["python", "app/main.py", "--port", "3333"]

  agentk-client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: agentk-streamlit-client
    ports:
      - "8501:8501"
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - STREAMLIT_SERVER_HEADLESS=${STREAMLIT_SERVER_HEADLESS:-true}
      - STREAMLIT_SERVER_ENABLE_CORS=${STREAMLIT_SERVER_ENABLE_CORS:-false}
      # # URL raiz, como vocÃª confirmou que era o original:
      # - MCP_SERVER_URL=${MCP_SERVER_URL:-http://agentk-server:3333}
      # URL correta para o endpoint SSE
      - MCP_SERVER_URL=${MCP_SERVER_URL:-http://agentk-server:3333/sse}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    networks:
      - agentk-network
    depends_on:
      agentk-server:
        condition: service_healthy
    restart: unless-stopped

networks:
  agentk-network:
    driver: bridge
    name: agentk-network

volumes:
  agentk-logs:
    driver: local
